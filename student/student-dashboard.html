<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TreydBuddy ‚Äî Student Dashboard</title>
  <link rel="stylesheet" href="../assets/student.css?v=2" />
</head>
<body>
  <div class="layout">
    <!-- ============ Sidebar ============ -->
    <aside class="sidebar" id="sidebar" aria-label="Student navigation">
      <a class="brand" href="#">
        <span class="logo">TB</span>
        <span>TreydBuddy</span>
      </a>

      <nav class="nav" id="nav">
        <a class="nav-link active" href="#events" data-target="events" aria-current="page">
          <span class="icon">üéâ</span> Events
        </a>
        <a class="nav-link" href="#my-reservations" data-target="my-reservations">
          <span class="icon">üßæ</span> My Reservations
        </a>
        <a class="nav-link" href="#attendance" data-target="attendance">
          <span class="icon">üóÇÔ∏è</span> Attendance
        </a>
        <a class="nav-link" href="#billing" data-target="billing">
          <span class="icon">üí≥</span> Billing
        </a>
        <a class="nav-link" href="#profile" data-target="profile">
          <span class="icon">üßë‚Äçüéì</span> Profile
        </a>
      </nav>

      <div class="sidebar-footer">
        <form action="/treydbuddy2/auth/auth-logout.php" method="post">
          <button type="submit" class="btn btn-ghost" style="width:100%;">Sign out</button>
        </form>
      </div>
    </aside>

    <!-- ============ Main ============ -->
    <div class="main">
      <!-- Topbar -->
      <header class="topbar">
        <button class="menu-btn" id="menuBtn" aria-expanded="false" aria-controls="sidebar">‚ò∞</button>

        <div class="search" role="search">
          <form id="searchForm" action="#" onsubmit="return false;">
            <input class="input" id="searchInput" type="search" name="q" placeholder="Search upcoming events‚Ä¶" />
          </form>
        </div>

        <div class="account">
          <div class="avatar" aria-label="Student account" id="avatarInitials">ST</div>
        </div>
      </header>

      <!-- ============ SPA Content Area ============ -->
      <main class="content" id="content" tabindex="-1" aria-live="polite">

        <!-- ===== Events (Explore) ===== -->
        <section class="route" id="route-events">
          <section class="cards">
            <article class="card kpi">
              <div class="kpi-head">
                <span class="kpi-title">Upcoming Events</span>
                <span class="kpi-icon">üéâ</span>
              </div>
              <div class="kpi-value" id="kpiUpcoming">‚Äî</div>
              <div class="kpi-sub">open for reservation</div>
            </article>

            <article class="card kpi">
              <div class="kpi-head">
                <span class="kpi-title">My Reservations</span>
                <span class="kpi-icon">üßæ</span>
              </div>
              <div class="kpi-value" id="kpiMyRes">‚Äî</div>
              <div class="kpi-sub">active</div>
            </article>

            <article class="card kpi">
              <div class="kpi-head">
                <span class="kpi-title">Payments Due</span>
                <span class="kpi-icon">üí≥</span>
              </div>
              <div class="kpi-value" id="kpiDue">‚Äî</div>
              <div class="kpi-sub">billing items</div>
            </article>
          </section>

          <article class="card table-card">
            <div class="table-head">
              <h2 class="section-title">Explore events</h2>
            </div>

            <div class="table-wrap">
              <table class="table" id="tblEvents">
                <thead>
                  <tr>
                    <th>Title</th>
                    <th>Date</th>
                    <th>Slots</th>
                    <th>Reserved</th>
                    <th>Status</th>
                    <th class="t-right">Actions</th>
                  </tr>
                </thead>
                <tbody><!-- filled by JS --></tbody>
              </table>
            </div>
          </article>
        </section>

        <!-- ===== My Reservations ===== -->
        <section class="route" id="route-my-reservations" hidden>
          <article class="card table-card">
            <div class="table-head">
              <h2 class="section-title">My reservations</h2>
            </div>

            <div class="table-wrap">
              <table class="table" id="tblMyReservations">
                <thead>
                  <tr>
                    <th>Event</th>
                    <th>Reserved on</th>
                    <th>Payment</th>
                    <th>Status</th>
                    <th class="t-right">Actions</th>
                  </tr>
                </thead>
                <tbody><!-- filled by JS --></tbody>
              </table>
            </div>
          </article>
        </section>

        <!-- ===== Attendance ===== -->
        <section class="route" id="route-attendance" hidden>
          <article class="card">
            <h2 class="section-title">Attendance history</h2>

            <div class="table-wrap">
              <table class="table" id="tblAttendance">
                <thead>
                  <tr>
                    <th>Event</th>
                    <th>Date</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody><!-- filled by JS --></tbody>
              </table>
            </div>
          </article>
        </section>

        <!-- ===== Billing ===== -->
        <section class="route" id="route-billing" hidden>
          <article class="card table-card">
            <div class="table-head">
              <h2 class="section-title">Billing & payments</h2>
              <button class="btn btn-primary" data-open="modal-schedule">Schedule payment</button>
            </div>

            <div class="table-wrap">
              <table class="table" id="tblBilling">
                <thead>
                  <tr>
                    <th>Invoice #</th>
                    <th>Event</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th class="t-right">Actions</th>
                  </tr>
                </thead>
                <tbody><!-- filled by JS --></tbody>
              </table>
            </div>
          </article>
        </section>

        <!-- ===== Profile (NEW) ===== -->
        <section class="route" id="route-profile" hidden>
          <article class="card profile-card">
            <div class="profile-head">
              <div class="profile-avatar" id="profileAvatar" aria-hidden="true">ST</div>
              <div class="profile-meta">
                <h2 class="section-title" id="profileName">Student Name</h2>
                <p class="muted" id="profileEmail">name@student.bpsu.edu.ph</p>
              </div>

              <div class="profile-actions">
                <button class="btn btn-primary" id="btnEditProfile">Edit</button>
                <button class="btn btn-ghost" id="btnCancelEdit" hidden>Cancel</button>
                <button class="btn btn-primary" id="btnSaveProfile" hidden>Save</button>
              </div>
            </div>

            <form id="formProfile" class="profile-form" autocomplete="off">
              <div class="grid-2">
                <label>
                  <span class="label">Student ID</span>
                  <input class="input" name="studentId" id="pfId" disabled />
                </label>

                <label>
                  <span class="label">Program</span>
                  <input class="input" name="program" id="pfProgram" disabled />
                </label>
              </div>

              <div class="grid-2">
                <label>
                  <span class="label">First name</span>
                  <input class="input" name="fname" id="pfFname" disabled required />
                </label>

                <label>
                  <span class="label">Last name</span>
                  <input class="input" name="lname" id="pfLname" disabled required />
                </label>
              </div>

              <div class="grid-2">
                <label>
                  <span class="label">Email</span>
                  <input class="input" type="email" name="email" id="pfEmail" disabled required />
                </label>

                <label>
                  <span class="label">Contact No.</span>
                  <input class="input" name="phone" id="pfPhone" disabled />
                </label>
              </div>

              <label>
                <span class="label">Address</span>
                <input class="input" name="address" id="pfAddress" disabled />
              </label>

              <!-- Optional: Change password trigger (front-end only; no modal added) -->
              <!-- <button class="btn btn-ghost" type="button" disabled>Change password</button> -->
            </form>
          </article>
        </section>
      </main>
    </div>
  </div>

  <!-- ============ Modals from earlier (Reserve / Schedule) ============ -->
  <dialog class="modal" id="modal-reserve">
    <form class="modal-card" id="formReserve">
      <h3 class="modal-title">Reserve a ticket</h3>
      <label>
        <span class="label">Event</span>
        <input class="input" name="event" id="reserveEvent" readonly />
      </label>
      <div class="grid-2">
        <label>
          <span class="label">Quantity</span>
          <input class="input" type="number" name="qty" min="1" value="1" required />
        </label>
        <label>
          <span class="label">Payment option</span>
          <select class="input" name="payment" required>
            <option value="Full">Full payment</option>
            <option value="Schedule">Schedule (installment)</option>
          </select>
        </label>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-ghost" data-close>Cancel</button>
        <button type="submit" class="btn btn-primary">Reserve</button>
      </div>
    </form>
  </dialog>

  <dialog class="modal" id="modal-schedule">
    <form class="modal-card" id="formSchedule">
      <h3 class="modal-title">Schedule a payment</h3>
      <label>
        <span class="label">Invoice #</span>
        <select class="input" name="invoice" id="scheduleInvoice" required></select>
      </label>
      <div class="grid-2">
        <label>
          <span class="label">First due date</span>
          <input class="input" type="date" name="date" required />
        </label>
        <label>
          <span class="label">Number of parts</span>
          <input class="input" type="number" name="parts" min="2" max="6" value="2" required />
        </label>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-ghost" data-close>Cancel</button>
        <button type="submit" class="btn btn-primary">Save schedule</button>
      </div>
    </form>
  </dialog>

  <!-- ============ Script ============ -->
  <script>
    // Data containers (empty by default; fill via API later)
    const db = {
      profile: {},
      events: [],
      myReservations: [],
      attendance: [],
      billing: []
    };

    // -----------------------
    // Helpers
    // -----------------------
    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

    function setActive(target) {
      $$(".route").forEach(sec => sec.hidden = true);
      $("#route-" + target).hidden = false;
      $$("#nav .nav-link").forEach(a => a.classList.toggle("active", a.dataset.target === target));
      $("#content").focus({ preventScroll: true });
    }

    function pill(status) {
      const cls = status === "Paid" || status === "Present" || status === "Open" ? "success"
                : status === "Pending" || status === "Filling" ? "warning"
                : "danger";
      return `<span class="pill ${cls}">${status}</span>`;
    }

    function initials(name) {
      const parts = name.trim().split(/\s+/);
      return (parts[0][0] || "") + (parts[1]?.[0] || "");
    }

    // -----------------------
    // Renderers
    // -----------------------
    function renderEvents() {
      const rows = (db.events || []).map(e => `
        <tr>
          <td>${e.title}</td>
          <td>${new Date(e.date).toLocaleDateString()}</td>
          <td>${e.slots}</td>
          <td>${e.reserved}</td>
          <td>${pill(e.status)}</td>
          <td class="t-right">
            <button class="link" ${e.status === "Full" ? "disabled" : `data-reserve="${e.id}"`}>Reserve</button>
          </td>
        </tr>
      `).join("");
      $("#tblEvents tbody").innerHTML = rows;
      $("#kpiUpcoming").textContent = (db.events || []).filter(e => e.status !== "Full").length;
    }

    function renderMyReservations() {
      const rows = (db.myReservations || []).map(r => `
        <tr>
          <td>${r.event}</td>
          <td>${new Date(r.date).toLocaleDateString()}</td>
          <td>‚Ç±${r.amount}</td>
          <td>${pill(r.status)}</td>
          <td class="t-right">
            ${r.status === "Pending" ? `<button class="link" data-open="modal-schedule">Schedule</button>` : `<span class="help">‚Äî</span>`}
          </td>
        </tr>
      `).join("");
      $("#tblMyReservations tbody").innerHTML = rows;
      $("#kpiMyRes").textContent = (db.myReservations || []).length;
    }

    function renderAttendance() {
      const rows = (db.attendance || []).map(a => `
        <tr>
          <td>${a.event}</td>
          <td>${new Date(a.date).toLocaleDateString()}</td>
          <td>${pill(a.status)}</td>
        </tr>
      `).join("");
      $("#tblAttendance tbody").innerHTML = rows;
    }

    function renderBilling() {
      const rows = (db.billing || []).map(b => `
        <tr>
          <td>${b.invoice}</td>
          <td>${b.event}</td>
          <td>‚Ç±${b.amount}</td>
          <td>${pill(b.status)}</td>
          <td class="t-right">
            ${b.status === "Pending" ? `<button class="link" data-open="modal-schedule">Schedule</button>` : `<span class="help">‚Äî</span>`}
          </td>
        </tr>
      `).join("");
      $("#tblBilling tbody").innerHTML = rows;
      $("#kpiDue").textContent = (db.billing || []).filter(b => b.status === "Pending").length;
      $("#scheduleInvoice").innerHTML = (db.billing || [])
        .filter(b => b.status === "Pending")
        .map(b => `<option value="${b.invoice}">${b.invoice} ‚Äî ${b.event}</option>`)
        .join("");
    }

    function renderProfile() {
      const p = db.profile || {};
      $("#pfId").value = p.studentId || "";
      $("#pfProgram").value = p.program || "";
      $("#pfFname").value = p.fname || "";
      $("#pfLname").value = p.lname || "";
      $("#pfEmail").value = p.email || "";
      $("#pfPhone").value = p.phone || "";
      $("#pfAddress").value = p.address || "";

      const name = `${p.fname || ""} ${p.lname || ""}`.trim();
      $("#profileName").textContent = name || "Student";
      $("#profileEmail").textContent = p.email || "";
      $("#profileAvatar").textContent = initials(name || "ST");
      $("#avatarInitials").textContent = initials(name || "ST");
    }

    // -----------------------
    // Profile edit / save
    // -----------------------
    let editing = false;

    function setProfileEditing(on) {
      editing = on;
      const fields = ["pfProgram","pfFname","pfLname","pfEmail","pfPhone","pfAddress"];
      fields.forEach(id => { const el = document.getElementById(id); el.disabled = !on; });
      document.getElementById("btnEditProfile").hidden = on;
      document.getElementById("btnCancelEdit").hidden = !on;
      document.getElementById("btnSaveProfile").hidden = !on;
    }

    document.getElementById("btnEditProfile").addEventListener("click", () => setProfileEditing(true));

    document.getElementById("btnCancelEdit").addEventListener("click", () => {
      setProfileEditing(false);
      renderProfile(); // reset fields to last saved data
    });

    document.getElementById("btnSaveProfile").addEventListener("click", () => {
      // Validate minimal fields
      const email = document.getElementById("pfEmail").value.trim();
      if (!email || !email.includes("@")) { alert("Please enter a valid email."); return; }

      // Save to mock state (replace with POST /student/profile later)
      db.profile = {
        studentId: document.getElementById("pfId").value,
        program: document.getElementById("pfProgram").value.trim(),
        fname: document.getElementById("pfFname").value.trim(),
        lname: document.getElementById("pfLname").value.trim(),
        email,
        phone: document.getElementById("pfPhone").value.trim(),
        address: document.getElementById("pfAddress").value.trim()
      };
      setProfileEditing(false);
      renderProfile();
      // In real app: show a small success toast or inline note (omitted per your no-notification guidance)
    });

    // -----------------------
    // Routing
    // -----------------------
    function go(hash) {
      const target = (hash || location.hash || "#events").replace("#", "");
      setActive(target);
    }
    window.addEventListener("hashchange", () => go());
    $$("#nav .nav-link").forEach(a => a.addEventListener("click", (e) => {
      const t = e.currentTarget.getAttribute("data-target");
      if (t) setTimeout(() => setActive(t), 0);
    }));

    // mobile sidebar toggle
    const btn = document.getElementById("menuBtn");
    const layout = document.querySelector(".layout");
    btn?.addEventListener("click", () => {
      const open = layout.classList.toggle("sidebar-open");
      btn.setAttribute("aria-expanded", String(open));
    });

    // -----------------------
    // Modals
    // -----------------------
    function openModal(id) {
      const d = document.getElementById(id);
      if (!d.open) d.showModal();
    }
    function closeModal(node) {
      const d = node.closest("dialog");
      if (d && d.open) d.close();
    }

    document.addEventListener("click", (e) => {
      const reserveBtn = e.target.closest("[data-reserve]");
      if (reserveBtn) {
        const id = +reserveBtn.getAttribute("data-reserve");
        const ev = db.events.find(x => x.id === id);
        $("#reserveEvent").value = ev.title;
        openModal("modal-reserve");
      }
      const opener = e.target.closest("[data-open]");
      if (opener) openModal(opener.getAttribute("data-open"));
      const closer = e.target.closest("[data-close]");
      if (closer) closeModal(closer);
    });

    // Reserve form
    $("#formReserve")?.addEventListener("submit", (ev) => {
      ev.preventDefault();
      const fd = new FormData(ev.currentTarget);
      db.myReservations.unshift({
        id: Date.now(),
        event: fd.get("event"),
        date: new Date().toISOString().slice(0,10),
        amount: 0,
        status: fd.get("payment") === "Full" ? "Paid" : "Pending"
      });
      renderMyReservations();
      closeModal(ev.currentTarget);
      location.hash = "#my-reservations";
    });

    // Schedule form
    $("#formSchedule")?.addEventListener("submit", (ev) => {
      ev.preventDefault();
      alert("Payment schedule saved (demo).");
      closeModal(ev.currentTarget);
      location.hash = "#billing";
    });

    // Search (filter events client-side)
    $("#searchInput")?.addEventListener("input", (e) => {
      const q = e.target.value.toLowerCase();
      const filtered = db.events.filter(ev => ev.title.toLowerCase().includes(q));
      const rows = filtered.map(e => `
        <tr>
          <td>${e.title}</td>
          <td>${new Date(e.date).toLocaleDateString()}</td>
          <td>${e.slots}</td>
          <td>${e.reserved}</td>
          <td>${pill(e.status)}</td>
          <td class="t-right">
            <button class="link" ${e.status === "Full" ? "disabled" : `data-reserve="${e.id}"`}>Reserve</button>
          </td>
        </tr>
      `).join("");
      $("#tblEvents tbody").innerHTML = rows || `<tr><td colspan="6">No matches</td></tr>`;
    });

    // -----------------------
    // Init
    // -----------------------
    renderEvents();
    renderMyReservations();
    renderAttendance();
    renderBilling();

    // Fetch profile data from backend and update UI
    fetch('/treydbuddy2/get-profile.php', {
      credentials: 'include' // send cookies/session if needed
    })
      .then(res => res.json())
      .then(profile => {
        db.profile = profile;
        renderProfile();
      })
      .catch(err => {
        console.error('Failed to load profile:', err);
        // Optionally show an error message or fallback
      });

    go();
  </script>
</body>
</html>
